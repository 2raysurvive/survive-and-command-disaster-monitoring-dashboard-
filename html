<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŒ‹ Survive & Command - AI-Powered Disaster Monitoring</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #dc2626;
            --primary-dark: #991b1b;
            --secondary: #1e40af;
            --warning: #f59e0b;
            --danger: #dc2626;
            --safe: #10b981;
            --dark: #1f2937;
            --light: #f8fafc;
            --gray: #6b7280;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            grid-template-rows: 70px 1fr;
            grid-template-areas:
                "sidebar header"
                "sidebar main";
            min-height: 100vh;
        }

        /* Header Styles */
        .header {
            grid-area: header;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-title h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ef4444, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid var(--safe);
            border-radius: 20px;
            font-size: 0.875rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--safe);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .emergency-mode {
            background: linear-gradient(135deg, #ef4444, #991b1b);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .emergency-mode:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6);
        }

        .emergency-mode.active {
            animation: emergencyPulse 1s infinite;
        }

        @keyframes emergencyPulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 4px 25px rgba(239, 68, 68, 0.8); }
        }

        /* Sidebar Styles */
        .sidebar {
            grid-area: sidebar;
            background: rgba(15, 23, 42, 0.98);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 2rem 1rem;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding: 0 1rem;
        }

        .logo-icon {
            font-size: 2rem;
            background: linear-gradient(135deg, #ef4444, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--gray);
            margin-bottom: 1rem;
            padding: 0 1rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 0.25rem;
            position: relative;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #ef4444, #f59e0b);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .nav-badge {
            position: absolute;
            right: 1rem;
            background: var(--danger);
            color: white;
            border-radius: 10px;
            padding: 0.1rem 0.5rem;
            font-size: 0.75rem;
        }

        /* Main Content */
        .main-content {
            grid-area: main;
            padding: 2rem;
            overflow-y: auto;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.1) 0%, rgba(30, 41, 59, 0.1) 100%);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        /* Alert Styles */
        .alert-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.3);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            animation: slideIn 0.5s ease;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .alert-item:hover {
            transform: translateX(5px);
            background: rgba(220, 38, 38, 0.2);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .alert-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .alert-critical {
            background: rgba(220, 38, 38, 0.15);
            border-color: var(--danger);
            border-left: 4px solid var(--danger);
        }
        .alert-high {
            background: rgba(245, 158, 11, 0.15);
            border-color: var(--warning);
            border-left: 4px solid var(--warning);
        }
        .alert-medium {
            background: rgba(59, 130, 246, 0.15);
            border-color: #3b82f6;
            border-left: 4px solid #3b82f6;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .alert-meta {
            font-size: 0.875rem;
            color: var(--gray);
        }

        /* Map Container */
        .map-container {
            height: 500px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 2rem;
            position: relative;
        }

        #disasterMap {
            height: 100%;
            width: 100%;
        }

        .map-overlay {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(30, 41, 59, 0.9);
            border-radius: 8px;
            padding: 1rem;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .map-controls {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .map-btn {
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .map-btn:hover {
            background: rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--gray);
        }

        /* AI Query Section */
        .query-section {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .query-input-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .query-input {
            flex: 1;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .query-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        .query-btn {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #ef4444, #f59e0b);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .query-btn:hover {
            transform: translateY(-2px);
        }

        .query-response {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid #ef4444;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Resource Grid */
        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .resource-card {
            text-align: center;
            padding: 1.5rem 1rem;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .resource-card:hover {
            transform: translateY(-5px);
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }

        .resource-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .resource-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .resource-desc {
            font-size: 0.875rem;
            color: var(--gray);
        }

        /* Response Teams */
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .team-card {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .team-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .team-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .team-status.available { background: var(--safe); }
        .team-status.deployed { background: var(--warning); }
        .team-status.engaged { background: var(--danger); }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 41, 59, 0.95);
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading::after {
            content: 'Loading...';
            display: block;
            text-align: center;
            color: var(--gray);
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--dark);
            border: 1px solid var(--gray);
            border-radius: 8px;
            padding: 1rem;
            max-width: 300px;
            z-index: 3000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid var(--safe);
        }

        .notification.error {
            border-left: 4px solid var(--danger);
        }

        .notification.warning {
            border-left: 4px solid var(--warning);
        }

        /* Spinner */
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid var(--warning);
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "header"
                    "main";
            }
            .sidebar {
                display: none;
            }
        }

        /* Animation for new alerts */
        @keyframes highlight {
            0% { background: rgba(239, 68, 68, 0.4); }
            100% { background: rgba(220, 38, 38, 0.1); }
        }

        .new-alert {
            animation: highlight 2s ease;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-title">
                <h1>ðŸŒ‹ Survive & Command</h1>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="systemStatus">System Operational</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="emergency-mode" id="emergencyToggle">
                    <i class="fas fa-bell"></i> Emergency Mode: <span id="emergencyStatus">OFF</span>
                </button>
            </div>
        </header>

        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="logo">
                <div class="logo-icon">âš¡</div>
                <h2>Disaster Command</h2>
            </div>

            <div class="nav-section">
                <div class="nav-title">Monitoring</div>
                <div class="nav-item active" data-section="dashboard">
                    <i class="fas fa-fire"></i>
                    <span>Live Dashboard</span>
                    <span class="nav-badge" id="dashboardBadge">0</span>
                </div>
                <div class="nav-item" data-section="map">
                    <i class="fas fa-map-marked-alt"></i>
                    <span>Threat Map</span>
                </div>
                <div class="nav-item" data-section="alerts">
                    <i class="fas fa-radiation"></i>
                    <span>Alert Feed</span>
                    <span class="nav-badge" id="alertsBadge">0</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Intelligence</div>
                <div class="nav-item" data-section="ai">
                    <i class="fas fa-brain"></i>
                    <span>AI Analysis</span>
                </div>
                <div class="nav-item" data-section="sources">
                    <i class="fas fa-database"></i>
                    <span>Data Sources</span>
                </div>
                <div class="nav-item" data-section="analytics">
                    <i class="fas fa-chart-line"></i>
                    <span>Trends & Analytics</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Response</div>
                <div class="nav-item" data-section="protocols">
                    <i class="fas fa-first-aid"></i>
                    <span>Emergency Protocols</span>
                </div>
                <div class="nav-item" data-section="coordination">
                    <i class="fas fa-users"></i>
                    <span>Coordination</span>
                    <span class="nav-badge" id="teamsBadge">0</span>
                </div>
                <div class="nav-item" data-section="safety">
                    <i class="fas fa-shield-alt"></i>
                    <span>Safety Zones</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">System</div>
                <div class="nav-item" data-section="health">
                    <i class="fas fa-heart-pulse"></i>
                    <span>System Health</span>
                </div>
                <div class="nav-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
                <div class="nav-item" data-section="logs">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Event Logs</span>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- System Status -->
            <div class="card" id="systemHealthCard" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">System Health</h3>
                    <div id="healthStatus"></div>
                </div>
                <div id="healthComponents"></div>
            </div>

            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="activeAlerts">0</div>
                    <div class="stat-label">Active Alerts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="criticalEvents">0</div>
                    <div class="stat-label">Critical Events</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="areasMonitored">12</div>
                    <div class="stat-label">Areas Monitored</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="responseTeams">8</div>
                    <div class="stat-label">Response Teams</div>
                </div>
            </div>

            <!-- Map Section -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Live Threat Map</h3>
                    <div class="map-controls">
                        <button class="query-btn" style="padding: 0.5rem 1rem; font-size: 0.875rem;" id="refreshMap">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="map-container">
                    <div id="disasterMap"></div>
                    <div class="map-overlay">
                        <div class="map-controls">
                            <button class="map-btn" id="showEarthquakes">
                                <i class="fas fa-mountain"></i> Earthquakes
                            </button>
                            <button class="map-btn" id="showWildfires">
                                <i class="fas fa-fire"></i> Wildfires
                            </button>
                            <button class="map-btn" id="showFloods">
                                <i class="fas fa-water"></i> Floods
                            </button>
                            <button class="map-btn" id="showAll">
                                <i class="fas fa-layer-group"></i> All Threats
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alert Feed & AI Query -->
            <div class="dashboard-grid">
                <!-- Alert Feed -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Live Alert Feed</h3>
                        <div>
                            <span class="nav-badge" id="criticalCount">0 CRITICAL</span>
                        </div>
                    </div>
                    <div class="alert-feed" id="alertFeed">
                        <div class="loading">Loading alerts...</div>
                    </div>
                </div>

                <!-- AI Query Section -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">AI Disaster Intelligence</h3>
                        <i class="fas fa-robot" style="color: #10b981;"></i>
                    </div>
                    <div class="query-section">
                        <div class="query-input-group">
                            <input type="text" class="query-input" id="aiQuery" placeholder="Ask about current threats, safety protocols, or emergency resources...">
                            <button class="query-btn" id="askAI">
                                <i class="fas fa-search"></i> Ask AI
                            </button>
                        </div>
                        <div class="query-response" id="aiResponse">
                            <strong>AI System Ready:</strong> Ask me about current disaster threats, emergency protocols, or request analysis of specific regions.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Response Teams -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Response Teams Status</h3>
                    <button class="query-btn" style="padding: 0.5rem 1rem; font-size: 0.875rem;" id="deployTeam">
                        <i class="fas fa-paper-plane"></i> Deploy Team
                    </button>
                </div>
                <div class="team-grid" id="responseTeamsGrid">
                    <div class="loading">Loading response teams...</div>
                </div>
            </div>

            <!-- Emergency Resources -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Emergency Resources</h3>
                </div>
                <div class="resource-grid">
                    <div class="resource-card" onclick="openResourceModal('medical')">
                        <div class="resource-icon" style="color: var(--danger);">
                            <i class="fas fa-first-aid"></i>
                        </div>
                        <div class="resource-title">Medical Aid</div>
                        <div class="resource-desc">Emergency medical services and supplies</div>
                    </div>
                    <div class="resource-card" onclick="openResourceModal('food')">
                        <div class="resource-icon" style="color: var(--warning);">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <div class="resource-title">Food & Water</div>
                        <div class="resource-desc">Emergency nutrition and hydration</div>
                    </div>
                    <div class="resource-card" onclick="openResourceModal('shelter')">
                        <div class="resource-icon" style="color: #3b82f6;">
                            <i class="fas fa-bed"></i>
                        </div>
                        <div class="resource-title">Shelters</div>
                        <div class="resource-desc">Safe locations and temporary housing</div>
                    </div>
                    <div class="resource-card" onclick="openResourceModal('communication')">
                        <div class="resource-icon" style="color: var(--safe);">
                            <i class="fas fa-phone-alt"></i>
                        </div>
                        <div class="resource-title">Hotlines</div>
                        <div class="resource-desc">Emergency contact information</div>
                    </div>
                </div>
            </div>

            <!-- RAG Analytics -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">MCP RAG Analytics</h3>
                    <button class="query-btn" style="padding: 0.5rem 1rem; font-size: 0.875rem;" id="refreshAnalytics">
                        <i class="fas fa-chart-bar"></i> Refresh
                    </button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <canvas id="performanceChart" width="400" height="200"></canvas>
                    </div>
                    <div>
                        <canvas id="sourceChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Emergency Protocol Modal -->
    <div class="modal" id="protocolModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Emergency Protocol</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div id="modalContent">
                <!-- Modal content will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // API Configuration
        const API_CONFIG = {
            BASE_URL: 'http://localhost:8000',
            ENDPOINTS: {
                EVENTS: '/api/events',
                RAG_QUERY: '/api/v1/rag/query',
                SYSTEM_HEALTH: '/api/system/health',
                RAG_METRICS: '/api/v1/rag/metrics',
                ALERTS: '/api/alerts'
            },
            WS_URL: 'ws://localhost:8000/ws'
        };

        // Global variables
        let map;
        let currentDisasters = [];
        let emergencyMode = false;
        let wsConnection = null;
        let performanceChart = null;
        let sourceChart = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // Main initialization function
        async function initializeApp() {
            try {
                showNotification('Initializing Disaster Monitoring System...', 'warning');
                // Initialize components
                await initializeMap();
                await checkSystemHealth();
                await loadEvents();
                await loadResponseTeams();
                await initializeWebSocket();
                await loadRAGAnalytics();
                setupEventListeners();
                showNotification('System initialized successfully', 'success');
            } catch (error) {
                console.error('Initialization error:', error);
                showNotification('Failed to initialize system: ' + error.message, 'error');
            }
        }

        // Initialize the map
        async function initializeMap() {
            map = L.map('disasterMap').setView([36.7783, -119.4179], 6);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            await loadMapEvents();
        }

        // Load events for the map
        async function loadMapEvents() {
            try {
                // Sample events data
                const sampleEvents = [
                    {
                        id: '1',
                        title: 'Magnitude 4.2 Earthquake',
                        description: 'Light earthquake detected near Ridgecrest, CA. No immediate damage reported.',
                        event_type: 'earthquake',
                        severity: 'medium',
                        latitude: 35.6225,
                        longitude: -117.6709,
                        region: 'Southern California',
                        source: 'USGS',
                        magnitude: 4.2,
                        created_at: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString()
                    },
                    {
                        id: '2',
                        title: 'Wildfire Spread Alert',
                        description: 'New wildfire reported in Angeles National Forest. Evacuations in progress.',
                        event_type: 'wildfire',
                        severity: 'high',
                        latitude: 34.3375,
                        longitude: -118.0723,
                        region: 'Southern California',
                        source: 'CAL FIRE',
                        acres: 1250,
                        created_at: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString()
                    },
                    {
                        id: '3',
                        title: 'Coastal Flood Warning',
                        description: 'High tide and storm surge causing flooding in coastal areas. Road closures reported.',
                        event_type: 'flood',
                        severity: 'medium',
                        latitude: 34.4208,
                        longitude: -119.6982,
                        region: 'Central Coast',
                        source: 'NOAA',
                        water_level: '3.2 ft',
                        created_at: new Date(Date.now() - 30 * 60 * 1000).toISOString()
                    }
                ];

                currentDisasters = sampleEvents;
                updateMapWithEvents(currentDisasters);
                updateAlertFeed(currentDisasters);
                updateCounters(currentDisasters);
            } catch (error) {
                console.error('Error loading events:', error);
                showNotification('Failed to load disaster events', 'error');
            }
        }

        // Update map with events
        function updateMapWithEvents(events) {
            // Clear existing markers
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            // Add markers to map
            events.forEach(event => {
                const icon = L.divIcon({
                    html: `<div style="background: ${getSeverityColor(event.severity)}; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                        <i class="fas fa-${getDisasterIcon(event.event_type)}"></i>
                    </div>`,
                    className: 'disaster-marker',
                    iconSize: [24, 24]
                });

                L.marker([event.latitude, event.longitude], { icon: icon })
                    .addTo(map)
                    .bindPopup(`
                        <div style="min-width: 250px;">
                            <h4 style="margin: 0 0 10px 0; color: ${getSeverityColor(event.severity)}">${event.title}</h4>
                            <p style="margin: 0 0 10px 0; font-size: 14px;">${event.description}</p>
                            <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                                <span style="background: ${getSeverityColor(event.severity)}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">${event.severity.toUpperCase()}</span>
                                <span style="background: #6b7280; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">${event.event_type}</span>
                            </div>
                            <button onclick="activateEmergencyProtocol('${event.id}')"
                                style="background: var(--danger); color: white; border: none; padding: 8px 16px; border-radius: 4px; width: 100%; cursor: pointer; font-weight: 600;">
                                Activate Emergency Response
                            </button>
                        </div>
                    `);
            });
        }

        // Update alert feed
        function updateAlertFeed(events) {
            const alertFeed = document.getElementById('alertFeed');
            alertFeed.innerHTML = '';

            if (events.length === 0) {
                alertFeed.innerHTML = '<div style="text-align: center; color: var(--gray); padding: 2rem;">No active alerts</div>';
                return;
            }

            // Sort by severity and timestamp
            events.sort((a, b) => {
                const severityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
                return severityOrder[a.severity] - severityOrder[b.severity] ||
                    new Date(b.created_at) - new Date(a.created_at);
            });

            events.forEach(event => {
                const alertElement = createAlertElement(event);
                alertFeed.appendChild(alertElement);
            });
        }

        // Create alert element
        function createAlertElement(event) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-item alert-${event.severity}`;
            alertDiv.innerHTML = `
                <div class="alert-icon" style="background: ${getSeverityColor(event.severity)};">
                    <i class="fas fa-${getDisasterIcon(event.event_type)}"></i>
                </div>
                <div class="alert-content">
                    <div class="alert-title">${event.title}</div>
                    <div class="alert-meta">${event.source} â€¢ ${formatTimeAgo(event.created_at)} â€¢ ${event.region}</div>
                </div>
            `;
            alertDiv.addEventListener('click', () => {
                showAlertDetails(event);
            });
            return alertDiv;
        }

        // Load events from API
        async function loadEvents() {
            try {
                updateCounters(currentDisasters);
            } catch (error) {
                console.error('Error loading events:', error);
                showNotification('Failed to load events', 'error');
            }
        }

        // Load response teams
        async function loadResponseTeams() {
            try {
                // Sample response teams data
                const teams = [
                    {
                        id: 1,
                        name: 'Medical Response Team Alpha',
                        status: 'available',
                        location: 'Base Camp',
                        specialization: 'Medical Aid'
                    },
                    {
                        id: 2,
                        name: 'Search & Rescue Team Bravo',
                        status: 'deployed',
                        location: 'Ventura County',
                        specialization: 'Urban Search & Rescue'
                    },
                    {
                        id: 3,
                        name: 'Engineering Team Charlie',
                        status: 'available',
                        location: 'Central Command',
                        specialization: 'Infrastructure Assessment'
                    },
                    {
                        id: 4,
                        name: 'Logistics Team Delta',
                        status: 'engaged',
                        location: 'Distribution Center',
                        specialization: 'Supply Chain Management'
                    }
                ];

                updateResponseTeamsGrid(teams);
            } catch (error) {
                console.error('Error loading response teams:', error);
                showNotification('Failed to load response teams', 'error');
            }
        }

        // Update response teams grid
        function updateResponseTeamsGrid(teams) {
            const teamsGrid = document.getElementById('responseTeamsGrid');
            teamsGrid.innerHTML = '';

            teams.forEach(team => {
                const teamElement = createTeamElement(team);
                teamsGrid.appendChild(teamElement);
            });
        }

        // Create team element
        function createTeamElement(team) {
            const teamDiv = document.createElement('div');
            teamDiv.className = 'team-card';
            teamDiv.innerHTML = `
                <div class="team-header">
                    <div class="team-status ${team.status}"></div>
                    <div>
                        <div style="font-weight: 600;">${team.name}</div>
                        <div style="font-size: 0.875rem; color: var(--gray);">${team.specialization}</div>
                    </div>
                </div>
                <div style="font-size: 0.875rem; margin-bottom: 10px;">
                    <i class="fas fa-map-marker-alt" style="margin-right: 5px;"></i> ${team.location}
                </div>
                <button class="map-btn" style="width: 100%;" onclick="deployTeam(${team.id})">
                    <i class="fas fa-paper-plane"></i> Deploy
                </button>
            `;
            return teamDiv;
        }

        // Initialize WebSocket connection
        function initializeWebSocket() {
            try {
                simulateWebSocketMessages();
            } catch (error) {
                console.error('WebSocket initialization error:', error);
            }
        }

        // Simulate WebSocket messages for demo
        function simulateWebSocketMessages() {
            const disasterTemplates = [
                {
                    type: 'earthquake',
                    titles: ['Seismic Activity Detected', 'Aftershock Alert', 'Earthquake Early Warning'],
                    descriptions: [
                        'Seismic sensors detecting ground movement',
                        'Aftershock following main seismic event',
                        'Early warning system activated'
                    ]
                },
                {
                    type: 'wildfire', 
                    titles: ['Wildfire Ignition', 'Fire Spread Alert', 'Evacuation Order'],
                    descriptions: [
                        'New fire reported in forested area',
                        'Rapid fire spread due to wind conditions',
                        'Immediate evacuation required'
                    ]
                },
                {
                    type: 'flood',
                    titles: ['Flood Warning', 'Flash Flood Alert', 'Coastal Flooding'],
                    descriptions: [
                        'River levels rising rapidly',
                        'Flash flood conditions detected',
                        'Coastal areas experiencing flooding'
                    ]
                }
            ];

            // Simulate new events every 20 seconds
            setInterval(() => {
                const template = disasterTemplates[Math.floor(Math.random() * disasterTemplates.length)];
                const severity = Math.random() > 0.7 ? 'high' : Math.random() > 0.4 ? 'medium' : 'low';
                
                const newEvent = {
                    id: 'live-' + Date.now(),
                    title: template.titles[Math.floor(Math.random() * template.titles.length)],
                    description: template.descriptions[Math.floor(Math.random() * template.descriptions.length)] + ' in region.',
                    event_type: template.type,
                    severity: severity,
                    latitude: 36.7783 + (Math.random() - 0.5) * 4,
                    longitude: -119.4179 + (Math.random() - 0.5) * 4,
                    region: ['Northern CA', 'Southern CA', 'Central Valley'][Math.floor(Math.random() * 3)],
                    source: 'Monitoring System',
                    created_at: new Date().toISOString()
                };
                
                handleWebSocketMessage({ type: 'NEW_EVENT', event: newEvent });
            }, 20000);
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'NEW_EVENT':
                    handleNewEvent(data.event);
                    break;
                case 'ALERT_UPDATE':
                    handleAlertUpdate(data.alert);
                    break;
                case 'SYSTEM_STATUS':
                    updateSystemStatus(data.status);
                    break;
                default:
                    console.log('Unknown WebSocket message type:', data.type);
            }
        }

        // Handle new event from WebSocket
        function handleNewEvent(event) {
            // Add to current disasters
            currentDisasters.push(event);
            // Update map
            updateMapWithEvents(currentDisasters);
            // Update alert feed
            updateAlertFeed(currentDisasters);
            // Update counters
            updateCounters(currentDisasters);
            // Show notification
            showNotification(`New ${event.event_type} alert: ${event.title}`, 'warning');
        }

        // Check system health
        async function checkSystemHealth() {
            try {
                const healthData = {
                    status: 'healthy',
                    components: {
                        database: 'connected',
                        rag_service: 'connected',
                        websocket: 'connected',
                        event_processor: 'connected'
                    }
                };
                updateSystemHealthDisplay(healthData);
            } catch (error) {
                console.error('Error checking system health:', error);
                updateSystemHealthDisplay({ status: 'error', components: {} });
            }
        }

        // Update system health display
        function updateSystemHealthDisplay(healthData) {
            const healthCard = document.getElementById('systemHealthCard');
            const healthStatus = document.getElementById('healthStatus');
            const healthComponents = document.getElementById('healthComponents');
            
            if (healthData.status === 'healthy') {
                healthStatus.innerHTML = '<span style="color: var(--safe);">âœ“ Healthy</span>';
                healthCard.style.display = 'block';
            } else {
                healthStatus.innerHTML = '<span style="color: var(--danger);">âœ— Unhealthy</span>';
                healthCard.style.display = 'block';
            }
            
            let componentsHtml = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">';
            Object.entries(healthData.components || {}).forEach(([component, status]) => {
                const statusColor = status === 'connected' ? 'var(--safe)' : 'var(--danger)';
                componentsHtml += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;">
                        <span>${component}</span>
                        <span style="color: ${statusColor};">${status}</span>
                    </div>
                `;
            });
            componentsHtml += '</div>';
            healthComponents.innerHTML = componentsHtml;
        }

        // Load RAG analytics
        async function loadRAGAnalytics() {
            try {
                const metrics = {
                    performance_timeline: [
                        {timestamp: new Date(Date.now() - 9 * 60 * 1000), response_time: 120},
                        {timestamp: new Date(Date.now() - 8 * 60 * 1000), response_time: 110},
                        {timestamp: new Date(Date.now() - 7 * 60 * 1000), response_time: 95},
                        {timestamp: new Date(Date.now() - 6 * 60 * 1000), response_time: 130},
                        {timestamp: new Date(Date.now() - 5 * 60 * 1000), response_time: 105},
                        {timestamp: new Date(Date.now() - 4 * 60 * 1000), response_time: 115},
                        {timestamp: new Date(Date.now() - 3 * 60 * 1000), response_time: 100},
                        {timestamp: new Date(Date.now() - 2 * 60 * 1000), response_time: 125},
                        {timestamp: new Date(Date.now() - 1 * 60 * 1000), response_time: 110},
                        {timestamp: new Date(), response_time: 105}
                    ],
                    source_distribution: {
                        'Emergency Protocols': 45,
                        'Weather Data': 25,
                        'Historical Events': 15,
                        'Response Guides': 15
                    }
                };
                
                updateRAGCharts(metrics);
            } catch (error) {
                console.error('Error loading RAG analytics:', error);
            }
        }

        // Update RAG charts
        function updateRAGCharts(metrics) {
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            const sourceCtx = document.getElementById('sourceChart').getContext('2d');
            
            // Destroy existing charts if they exist
            if (performanceChart) performanceChart.destroy();
            if (sourceChart) sourceChart.destroy();
            
            // Performance Chart
            performanceChart = new Chart(performanceCtx, {
                type: 'line',
                data: {
                    labels: metrics.performance_timeline.map(item => 
                        new Date(item.timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})
                    ),
                    datasets: [{
                        label: 'Response Time (ms)',
                        data: metrics.performance_timeline.map(item => item.response_time),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'RAG Performance'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Response Time (ms)'
                            }
                        }
                    }
                }
            });
            
            // Source Distribution Chart
            sourceChart = new Chart(sourceCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(metrics.source_distribution),
                    datasets: [{
                        data: Object.values(metrics.source_distribution),
                        backgroundColor: [
                            '#ef4444',
                            '#f59e0b',
                            '#10b981',
                            '#3b82f6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Data Sources'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Emergency mode toggle
            document.getElementById('emergencyToggle').addEventListener('click', toggleEmergencyMode);

            // AI query
            document.getElementById('askAI').addEventListener('click', handleAIQuery);
            document.getElementById('aiQuery').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleAIQuery();
                }
            });

            // Map controls
            document.getElementById('refreshMap').addEventListener('click', refreshMap);
            document.getElementById('showEarthquakes').addEventListener('click', () => filterMap('earthquake'));
            document.getElementById('showWildfires').addEventListener('click', () => filterMap('wildfire'));
            document.getElementById('showFloods').addEventListener('click', () => filterMap('flood'));
            document.getElementById('showAll').addEventListener('click', () => filterMap('all'));

            // Modal close
            document.getElementById('closeModal').addEventListener('click', closeModal);

            // Deploy team
            document.getElementById('deployTeam').addEventListener('click', deployNewTeam);

            // Analytics refresh
            document.getElementById('refreshAnalytics').addEventListener('click', loadRAGAnalytics);

            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.dataset.section;
                    navigateToSection(section);
                });
            });
        }

        // Handle AI query with RAG API
        async function handleAIQuery() {
            const query = document.getElementById('aiQuery').value;
            const responseElement = document.getElementById('aiResponse');
            
            if (!query.trim()) {
                showNotification('Please enter a query', 'warning');
                return;
            }

            try {
                responseElement.innerHTML = '<div style="display: flex; align-items: center; gap: 10px; color: var(--warning);"><div class="spinner"></div><span>AI is analyzing disaster data and protocols...</span></div>';
                
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 1000));
                
                const response = generateAIResponse(query);
                responseElement.innerHTML = response;
                
                showNotification('AI analysis complete', 'success');
                
            } catch (error) {
                console.error('AI Query error:', error);
                responseElement.innerHTML = `
                    <div style="color: var(--danger);">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>System Temporarily Unavailable:</strong> 
                        Please try again in a moment. Emergency protocols remain active.
                    </div>
                `;
                showNotification('AI system busy - using cached protocols', 'error');
            }
            
            document.getElementById('aiQuery').value = '';
        }

        function generateAIResponse(query) {
            const queryLower = query.toLowerCase();
            let mainResponse = '';
            let sources = [];
            let recommendations = [];

            // Earthquake responses
            if (queryLower.includes('earthquake') || queryLower.includes('shake') || queryLower.includes('seismic')) {
                mainResponse = "**EARTHQUAKE RESPONSE PROTOCOL ACTIVATED**\n\n";
                mainResponse += "Immediate Actions Required:\n";
                mainResponse += "â€¢ **DROP** to your hands and knees\n"; 
                mainResponse += "â€¢ **COVER** your head and neck under sturdy furniture\n";
                mainResponse += "â€¢ **HOLD ON** until shaking stops\n\n";
                
                recommendations = [
                    "Stay away from windows and exterior walls",
                    "Do not use elevators during or after shaking",
                    "Check for gas leaks and turn off if safe to do so",
                    "Be prepared for aftershocks"
                ];
                
                sources = [
                    "FEMA Earthquake Response Guide v4.2",
                    "USGS Seismic Safety Protocol",
                    "California Office of Emergency Services"
                ];
            }
            // Wildfire responses
            else if (queryLower.includes('wildfire') || queryLower.includes('fire')) {
                mainResponse = "**WILDFIRE EMERGENCY PROTOCOL**\n\n";
                mainResponse += "Critical Evacuation Guidelines:\n";
                
                recommendations = [
                    "Evacuate immediately if ordered - do not delay",
                    "Close all windows, vents, and doors",
                    "Shut off gas at the meter if time permits",
                    "Wear protective clothing (cotton/wool, long sleeves)",
                    "Follow designated evacuation routes"
                ];
                
                sources = [
                    "CAL FIRE Emergency Response Manual",
                    "National Interagency Fire Center",
                    "Wildfire Evacuation Planning Guide"
                ];
            }
            // Flood responses
            else if (queryLower.includes('flood') || queryLower.includes('water') || queryLower.includes('rain')) {
                mainResponse = "**FLOOD SAFETY PROTOCOL**\n\n";
                mainResponse += "Flood Emergency Procedures:\n";
                
                recommendations = [
                    "Move to higher ground immediately",
                    "Avoid walking through moving water (6+ inches)",
                    "Do not drive into flooded areas",
                    "Evacuate if instructed by authorities",
                    "Stay away from electrical equipment"
                ];
                
                sources = [
                    "NOAA Flood Safety Guidelines",
                    "National Weather Service Protocols",
                    "Flood Emergency Response Handbook"
                ];
            }
            // General emergency
            else {
                mainResponse = "**DISASTER RESPONSE INTELLIGENCE**\n\n";
                mainResponse += "Based on current threat analysis and historical data:\n";
                
                recommendations = [
                    "Monitor official emergency channels continuously",
                    "Prepare emergency kit with 72-hour supplies",
                    "Establish family communication plan",
                    "Know your evacuation routes and shelters",
                    "Follow instructions from emergency personnel"
                ];
                
                sources = [
                    "FEMA Comprehensive Preparedness Guide",
                    "Disaster Response Best Practices",
                    "Emergency Management Protocols"
                ];
            }

            // Format the response
            let htmlResponse = `
                <div style="margin-bottom: 15px;">
                    <strong style="color: #ef4444;">ðŸŒ‹ AI DISASTER INTELLIGENCE:</strong>
                    <div style="margin-top: 10px; line-height: 1.6;">${mainResponse.replace(/\n/g, '<br>')}</div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>ðŸ“‹ Recommended Actions:</strong>
                    <ul style="margin-top: 8px; padding-left: 20px;">
                        ${recommendations.map(rec => `<li style="margin-bottom: 5px;">${rec}</li>`).join('')}
                    </ul>
                </div>
                
                <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
                    <strong>ðŸ“š Verified Sources:</strong>
                    <div style="font-size: 0.875rem; color: var(--gray); margin-top: 8px;">
                        ${sources.map(src => `<div style="margin-bottom: 4px;">â€¢ ${src}</div>`).join('')}
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 4px solid var(--safe);">
                    <strong>ðŸ”„ Real-time Analysis:</strong> This response incorporates current threat data, historical patterns, and verified emergency protocols.
                </div>
            `;
            
            return htmlResponse;
        }

        // Update counters
        function updateCounters(events) {
            const criticalCount = events.filter(event => event.severity === 'high').length;
            
            document.getElementById('activeAlerts').textContent = events.length;
            document.getElementById('criticalEvents').textContent = criticalCount;
            document.getElementById('criticalCount').textContent = `${criticalCount} CRITICAL`;
            
            // Update badges
            document.getElementById('dashboardBadge').textContent = events.length;
            document.getElementById('alertsBadge').textContent = events.length;
            document.getElementById('teamsBadge').textContent = '4';
        }

        // Utility functions
        function getDisasterIcon(type) {
            const icons = {
                earthquake: 'mountain',
                wildfire: 'fire',
                flood: 'water',
                tornado: 'wind',
                hurricane: 'hurricane',
                tsunami: 'water',
                storm: 'cloud-showers-heavy',
                landslide: 'mountain',
                power_outage: 'bolt'
            };
            return icons[type] || 'exclamation-triangle';
        }

        function getSeverityColor(severity) {
            const colors = {
                critical: '#dc2626',
                high: '#f59e0b',
                medium: '#3b82f6',
                low: '#10b981'
            };
            return colors[severity] || '#6b7280';
        }

        function formatTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffMs = now - time;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            return `${Math.floor(diffHours / 24)} day${Math.floor(diffHours / 24) > 1 ? 's' : ''} ago`;
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            container.appendChild(notification);
            
            // Show notification
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Remove notification after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        // Placeholder functions for remaining features
        function toggleEmergencyMode() {
            emergencyMode = !emergencyMode;
            const button = document.getElementById('emergencyToggle');
            const status = document.getElementById('emergencyStatus');
            
            if (emergencyMode) {
                button.classList.add('active');
                status.textContent = 'ACTIVE';
                showNotification('Emergency mode activated - All systems at maximum alert', 'warning');
                document.body.style.animation = 'emergencyPulse 2s infinite';
            } else {
                button.classList.remove('active');
                status.textContent = 'OFF';
                showNotification('Emergency mode deactivated', 'info');
                document.body.style.animation = 'none';
            }
        }

        function refreshMap() {
            loadMapEvents();
            showNotification('Map data refreshed', 'success');
        }

        function filterMap(type) {
            const buttons = document.querySelectorAll('.map-btn');
            buttons.forEach(btn => btn.style.background = 'rgba(30, 41, 59, 0.9)');
            
            event.target.style.background = 'rgba(59, 130, 246, 0.3)';
            
            let filteredEvents = currentDisasters;
            if (type !== 'all') {
                filteredEvents = currentDisasters.filter(event => event.event_type === type);
            }
            
            updateMapWithEvents(filteredEvents);
            showNotification(`Showing ${type === 'all' ? 'all' : type} threats (${filteredEvents.length} active)`, 'success');
        }

        function showAlertDetails(alert) {
            document.getElementById('modalTitle').textContent = alert.title;
            document.getElementById('modalContent').innerHTML = `
                <p><strong>Severity:</strong> <span style="color: ${getSeverityColor(alert.severity)}">${alert.severity.toUpperCase()}</span></p>
                <p><strong>Type:</strong> ${alert.event_type}</p>
                <p><strong>Region:</strong> ${alert.region}</p>
                <p><strong>Time:</strong> ${new Date(alert.created_at).toLocaleString()}</p>
                <p><strong>Source:</strong> ${alert.source}</p>
                <div style="margin-top: 20px;">
                    <h4>Description:</h4>
                    <p>${alert.description}</p>
                </div>
                <button class="query-btn" style="margin-top: 20px; width: 100%;" onclick="activateEmergencyProtocol('${alert.id}')">
                    <i class="fas fa-bell"></i> Activate Emergency Response
                </button>
            `;
            document.getElementById('protocolModal').style.display = 'block';
        }

        function activateEmergencyProtocol(eventId) {
            showNotification(`Emergency protocol activated for event ${eventId}`, 'warning');
            closeModal();
        }

        function deployTeam(teamId) {
            showNotification(`Team ${teamId} deployment initiated`, 'success');
        }

        function deployNewTeam() {
            document.getElementById('modalTitle').textContent = 'Deploy New Response Team';
            document.getElementById('modalContent').innerHTML = `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Team Name</label>
                    <input type="text" class="query-input" placeholder="Enter team name" style="width: 100%;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Specialization</label>
                    <select class="query-input" style="width: 100%;">
                        <option>Medical Aid</option>
                        <option>Search & Rescue</option>
                        <option>Engineering</option>
                        <option>Logistics</option>
                        <option>Communication</option>
                    </select>
                </div>
                <button class="query-btn" style="width: 100%; margin-top: 10px;">
                    <i class="fas fa-paper-plane"></i> Deploy Team
                </button>
            `;
            document.getElementById('protocolModal').style.display = 'block';
        }

        function openResourceModal(resourceType) {
            const resourceTitles = {
                medical: 'Medical Aid Resources',
                food: 'Food & Water Resources',
                shelter: 'Emergency Shelters',
                communication: 'Emergency Communication'
            };
            
            const resourceContent = {
                medical: `
                    <h4>Emergency Medical Services</h4>
                    <ul>
                        <li>Emergency Medical Teams: Available 24/7</li>
                        <li>Field Hospitals: 3 locations in affected areas</li>
                        <li>Medical Supplies: Distributed through aid stations</li>
                        <li>Emergency Hotline: 1-800-MED-HELP</li>
                    </ul>
                `,
                food: `
                    <h4>Food & Water Distribution</h4>
                    <ul>
                        <li>Emergency Rations: MREs and water available</li>
                        <li>Distribution Centers: 12 locations across region</li>
                        <li>Mobile Food Units: 5 units deployed</li>
                        <li>Water Purification: Emergency stations established</li>
                    </ul>
                `,
                shelter: `
                    <h4>Emergency Shelter Information</h4>
                    <ul>
                        <li>Red Cross Shelters: 8 locations activated</li>
                        <li>Capacity: 2,500+ individuals</li>
                        <li>Pets: Designated shelters available</li>
                        <li>Special Needs: Accessible facilities provided</li>
                    </ul>
                `,
                communication: `
                    <h4>Emergency Communication</h4>
                    <ul>
                        <li>Emergency Hotline: 1-800-DISASTER</li>
                        <li>Text Alerts: Text "ALERT" to 90999</li>
                        <li>Radio: Emergency broadcast on 107.7 FM</li>
                        <li>Mobile App: Download "Emergency Alert CA"</li>
                    </ul>
                `
            };
            
            document.getElementById('modalTitle').textContent = resourceTitles[resourceType] || 'Emergency Resources';
            document.getElementById('modalContent').innerHTML = resourceContent[resourceType] || '<p>Resource information not available.</p>';
            document.getElementById('protocolModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('protocolModal').style.display = 'none';
        }

        function navigateToSection(section) {
            showNotification(`Navigating to ${section} section`, 'info');
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-section="${section}"]`).classList.add('active');
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('protocolModal');
            if (event.target === modal) {
                closeModal();
            }
        });
    </script>
</body>
</html>
